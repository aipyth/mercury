"use strict";

///////////////// SOME FUNCTIONS //////////////////
var log = mess => {
  console.log(mess);
};

var responseResult = (response, status, good_result, bad_result) => {
  if (response.status == status) good_result();else bad_result();
}; //////////////////////////////////////////////////
/////////////// MENU JS CODE /////////////////////


var this_week = 0;
$('#sign').on('click', () => {
  $('section.modal').addClass('vis');
});
$('#shemes').click(() => {
  timeShemes();
});
$('#nextweek').click(() => {
  var wek = $('.nextweek-button h3');
  wek.html('Week 2');
  $('#nextweek').addClass('thisweekhiden');
  $('#prevweek').removeClass('thisweekhiden');
  this_week = 1;
  displayDays(Weeks[this_week]);
});
$('#prevweek').click(() => {
  $('.nextweek-button h3').html('Week 1');
  $('#prevweek').addClass('thisweekhiden');
  $('#nextweek').removeClass('thisweekhiden');
  this_week = 0;
  displayDays(Weeks[this_week]);
}); ///////////////////////////////////////////////////////
///////////////////// SHEDULE //////////////////////
//////////////////// DISPLAY //////////////////

var Weeks = [{
  Monday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Tuesday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Wednesday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Thursday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Friday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Saturday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  }
}, {
  Monday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Tuesday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Wednesday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Thursday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Friday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  },
  Saturday: {
    subjects: [['', ''], ['', ''], ['', ''], ['', ''], ['', '']],
    times: ['8:30 - 10:05', '10:25 - 12:00', '12:20 - 13:55', '14:15 - 15:50', '16:10 - 17:45'],
    tasks: []
  }
}];

var postSubjects = () => {
  var array_of_all_subjects;
  var object_of_days_and_orders = {};

  for (var day of ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"]) {
    for (var week of Weeks) {
      var oneday_subjects = week[day][subjects];

      for (item in oneday_subjects) {
        if (item in object_of_days_and_orders) {
          object_of_days_and_orders[item[0]].push({
            day: oneday_subjects.indexOf(item) + 1
          });
        } else {
          object_of_days_and_orders[item[0]] = [{
            day: oneday_subjects.indexOf(item) + 1
          }];
        }
      }

      array_of_all_subjects.concat(week[day]);
    }
  }

  var all_subjects = new Set(array_of_all_subjects);

  for (subject in array_of_all_subjects) {
    window.fetch('/api/subjects/', {
      headers: {
        'Accept': 'application/json, text/plain',
        'Content-Type': 'application/json;charset=UTF-8'
      },
      method: 'POST',
      body: JSON.stringify({
        days_and_orders: object_of_days_and_orders[subject],
        name: subject[0],
        lector: subject[1]
      })
    }).then(response => responseResult(response, 200, log(response), () => {
      throw Error(response);
    }));
  }
};

var getWeek = () => {};

getWeek();

var getDayId = daytag => ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"].indexOf(daytag);

var displayShedule = (jquerObj, week_day) => {
  for (var index = 0; index < 5; index++) {
    var subjsection = jquerObj.find("div.subj-section.".concat(index + 1));
    subjsection.find('.name').html(week_day['subjects'][index]);
    subjsection.find('.time').html(week_day['times'][index]);
  }
};

var displayDays = function displayDays(week) {
  var mainDay = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : -1;
  var arrayOfWeekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
  var currentDay = mainDay == -1 ? new Date().getDay() - 1 : mainDay;
  if (mainDay == -1) mainDay++;
  $('.shedule-main').find('h2').html(arrayOfWeekdays[currentDay]);
  displayShedule($('.shedule-main'), week[arrayOfWeekdays[currentDay]]);

  for (var i = 1, j = 0; i <= 5; i++, j++) {
    if (j == currentDay) {
      i--;
      continue;
    }

    $(".shedule.".concat(i)).find('h2').html(arrayOfWeekdays[j]);
    displayShedule($(".shedule.".concat(i)), week[arrayOfWeekdays[j]]);
  }
};

var changeSheduleSubject = thisweek => {
  var day = $('.shedule-main').find('h2').text();
  var parsefrom = $('.shedule-main .subjects .subj-section');

  for (var i = 0; i < 5; i++) {
    Weeks[thisweek][day]['subjects'][i] = $(parsefrom[i]).find('.name').text();
    console.log($(parsefrom[i]).html());
  }

  postWeek();
};

var changeSheduleTime = (thisweek, time) => {
  var time_expr = /^\d{1,2}:\d{2} - \d{1,2}:\d{2}$/;

  if (time.text().match(time_expr)) {
    var day = $('.shedule-main').find('h2').text();
    var parsefrom = $('.shedule-main .subjects .subj-section');

    for (var i = 0; i < 5; i++) {
      Weeks[thisweek][day]['times'][i] = $(parsefrom[i]).find('.time').text();
      console.log($(parsefrom[i]).html());
    }
  } else {
    time.addClass('error');
    time.text('Input time correctly');
  }
};

$('.shedule-main').find('.subj-section .time').on('focus', function () {
  if ($(this).text() == 'Input time correctly') {
    $(this).text('');
    $(this).removeClass('error');
  }
});
$('.shedule-main').find('.subj-section .name').on('focusout', () => {
  changeSheduleSubject(this_week);
  console.log(Weeks);
});
$('.shedule-main').find('.subj-section .time').on('focusout', function () {
  changeSheduleTime(this_week, $(this));
  console.log(Weeks);
});
$('.shedule').on('click', function () {
  var daytag = $(this).find('h2').text();
  console.log(getDayId(daytag));
  displayDays(Weeks[this_week], getDayId(daytag));
});
$(function () {
  displayDays(Weeks[this_week]);
}); //////////////////////////////////////////////////////
/////////////////// SIGNING JS CODE ///////////////////

function signUpSucessful(resp, username, password) {
  resp.json().then(data => {
    $('#sign-sucess').html("<h2>Welcome to the club, buddy </h2>\n        <h2>".concat(data.email, "</h2>"));
    $('#sign-form').addClass('hidden');
    $('#sign-sucess').removeClass('hidden');
    setTimeout(() => {
      $('.modal').removeClass('vis');
    }, 5000);
  });
  window.fetch('/api/api-token-auth/', {
    headers: {
      'Accept': 'application/json, text/plain',
      'Content-Type': 'application/json;charset=UTF-8'
    },
    method: 'POST',
    body: JSON.stringify({
      username: username,
      password: password
    })
  }).then(response => saveToken(response));
  setTimeout(() => {
    alert(read_cookie('token'));
  }, 5000);
}

function signUpFail(resp) {
  resp.json().then(data => {
    $('#sign-errors').html("<p> *Error ".concat(data.email, " </p>"));
  });
}

function signUp(_ref) {
  var [username, password] = _ref;
  log(JSON.stringify({
    email: username,
    password: password
  }));
  window.fetch('/api/create-user/', {
    headers: {
      'Accept': 'application/json, text/plain',
      'Content-Type': 'application/json;charset=UTF-8'
    },
    method: 'POST',
    body: JSON.stringify({
      email: username,
      password: password
    })
  }).then(response => responseResult(response, 201, signUpSucessful(response, username, password), signUpFail(response))).catch(err => log(err));
}

function getAuth() {
  var email = $('#email').val();
  var password = $('#password').val();
  console.log(password);
  return [email, password];
}

function write_cookie(name, value) {
  // Build the expiration date string:
  var expiration_date = new Date();
  expiration_date.setYear(2025);
  expiration_date = expiration_date.toGMTString(); // Build the set-cookie string:

  var cookie_string = name + "=" + value + "; expires=" + expiration_date; // Create/update the cookie:

  document.cookie = cookie_string;
}

function read_cookie(key, skips) {
  // Set skips to 0 if parameter was omitted:
  if (skips == null) skips = 0; // Get cookie string and separate into individual cookie phrases:

  var cookie_string = "" + document.cookie;
  var cookie_array = cookie_string.split("; "); // Scan for desired cookie:

  for (var i = 0; i < cookie_array.length; ++i) {
    var single_cookie = cookie_array[i].split("=");
    if (single_cookie.length != 2) continue;
    var name = single_cookie[0];
    var value = single_cookie[1]; // Return cookie if found:

    if (key == name && skips-- == 0) return value;
  } // Cookie was not found:


  return null;
}

function saveToken(resp) {
  resp.json().then(data => {
    var token = data.token;
    write_cookie('token', token);
  });
}

$('.modal .cross').on('click', () => {
  $('.modal').removeClass('vis');
});
$(document).mouseup(e => {
  var modal = $('.sign-block');

  if (!modal.is(e.target) && modal.has(e.target).length === 0) {
    $('.modal').removeClass('vis');
  }
});
$('#next').on('click', () => {
  signUp(getAuth());
}); ///////////////////////////////////////////////////////////

function timeShemes() {
  var token = read_cookie('token');
  window.fetch('/api/timeshemes/', {
    headers: {
      'Accept': 'application/json, text/plain',
      'Content-Type': 'application/json;charset=UTF-8',
      'Authorization': "Token ".concat(token)
    },
    method: 'POST',
    body: JSON.stringify({
      id: 2,
      name: "KRAVMECH",
      items: [{
        start: "13:25:00",
        stop: "15:10:00"
      }]
    })
  }).then(response => responseResult(response, 201, (response => {
    response.json().then(data => {
      alert("Created subject ".concat(data.name, " that starts at ").concat(data.items[0].start, " and ends at ").concat(data.items[0].stop));
    });
  })(response), () => {
    throw Error("Error response status is ".concat(response.status));
  })).catch(err => log(err));
}